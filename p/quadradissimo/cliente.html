<!DOCTYPE html>
<html class="h-100">
<head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quadrad√≠ssimo - Cliente</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css"></head>
<body class="h-100 m-0 p-0"><canvas class="w-100 h-100 d-block"></canvas><script>
const ws = new WebSocket("ws://26.60.57.127:8080");

ws.onopen = () => console.log("Conectado ao servidor WebSocket!");//entrou

let aberto = false;

ws.addEventListener("open", e => {
  aberto = true;
  
});

//ws.send(m); enviar
let meuId = null

ws.onmessage = e => {

  const data = JSON.parse(e.data)

  if(data.type === "START"){
    meuId = data.id
    players.prota.id = meuId
  }

  // atualiza√ß√£o de players
  if(data.type === "UPDATE"){
    const inimigosTemp = [];
for (const p of data.players) {
      if (p.id === players.prota.id) {
        // üî• aqui sim voc√™ atualiza o prota
        players.prota.x = p.attributos.x;
        players.prota.y = p.attributos.y;
      } else {
        // üî• aqui voc√™ guarda inimigos
        inimigosTemp.push(p);
      }
    }

    players.inimigo = inimigosTemp;
  }
}


//canvas
function resizeCanvasToDisplaySize(canva) {
    const dpr = window.devicePixelRatio; // Propor√ß√£o de pixels do dispositivo
    const displayWidth = Math.round(canva.clientWidth * dpr);
    const displayHeight = Math.round(canva.clientHeight * dpr);

    if (canva.width !== displayWidth || canva.height !== displayHeight) {
        canva.width = displayWidth;
        canva.height = displayHeight;
    }
}

const canva = document.getElementsByTagName('canvas')[0]
resizeCanvasToDisplaySize(canva);


const d = canva.getContext("2d")

//tamanho

//teclas üòé
let key = {}
window.addEventListener("keydown", e =>{
  key[e.key.toLowerCase()] = true;
})
window.addEventListener("keyup", e =>{
  key[e.key.toLowerCase()] = false;
})

//playerProtagonista

const nome = prompt("Digite seu nome:", "Jogador");

players = {
  prota: {
    x: null,
    y: null,
    nome: nome,
    id: meuId
  }
}

function gameLoop(){
  d.clearRect(0,0, canva.width, canva. height)
  
  //fundo
  d.fillStyle = "lightgrey"
  d.fillRect(0,0, canva.width, canva.height)

  setTimeout(()=>{
    if (players.prota.id) EnviarEstado()
  }, 100)
  
    DesenharInimigos()
    DesenharProta()
    //MoverInimigos()

  requestAnimationFrame(gameLoop)
}

function DesenharProta(){
  d.fillStyle = "blue"
  d.fillRect(players.prota.x, players.prota.y, 50, 50)
  DesenharNome(players.prota.x, players.prota.y, players.prota.nome)
}

function DesenharInimigos(){ 
  if  (!players.inimigo) return;
  for (const enemy of players.inimigo) {

    const attr = enemy.attributos;

    d.fillStyle = "red"
    d.fillRect(attr.x, attr.y, 50, 50);
    DesenharNome(attr.x, attr.y, attr.nome ?? "Inimigo");
  }
}


function EnviarEstado(){
  ws.send(JSON.stringify({
    type: "state",
    key: key
  }))
}

function DesenharNome(x, y, nome){
  d.fillStyle = "black"
  d.font = "20px Arial"
  d.textAlign = "center"
  d.fillText(nome, x + 25, y - 10)
}

gameLoop()





</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script></body></html>
